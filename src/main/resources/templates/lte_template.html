<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<body>

<head th:fragment="head">
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/>
    <meta http-equiv="content-type" content="text/html; charset=UTF-8"/>
    <title>Buk bot</title>
    <!-- Tell the browser to be responsive to screen width -->
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- Font Awesome -->
    <link rel="stylesheet" th:href="@{lte/plugins/fontawesome-free/css/all.min.css}">
    <!-- Ionicons -->
    <link rel="stylesheet" href="https://code.ionicframework.com/ionicons/2.0.1/css/ionicons.min.css">
    <!-- overlayScrollbars -->
    <link rel="stylesheet" th:href="@{lte/dist/css/adminlte.min.css}">
    <!-- Google Font: Source Sans Pro -->
    <link rel="stylesheet" th:href="@{lte/my/apis.css}">
    <!-- DataTables -->
    <link rel="stylesheet" th:href="@{lte/plugins/datatables-bs4/css/dataTables.bootstrap4.min.css}">
    <link rel="stylesheet" th:href="@{lte/plugins/datatables-responsive/css/responsive.bootstrap4.min.css}">

    <link
            type="text/css"
            rel="stylesheet"
            th:href="@{assets/my/bootstrap-vue.min.css}"
    />

    <!-- Required scripts -->
    <script th:src="@{lte/my/axios.min.js}"></script>
    <script th:src="@{lte/my/vue.min.js}"></script>
    <script th:src="@{lte/my/bootstrap-vue.min.js}"></script>
    <script th:inline="javascript">
    const axiosConfig = {
        headers: {
        "content-Type": "application/x-www-form-urlencoded",
        "Accept": "text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3"
        },
        credentials: "same-origin"
    };
    </script>
</head>

<div th:fragment="menu">
        <!-- Navbar -->
    <div  id="contents">
        <nav class="main-header navbar navbar-expand navbar-white navbar-light">
            <ul class="navbar-nav">
                <li class="nav-item">
                    <a class="nav-link" data-widget="pushmenu" href="#" role="button"><i class="fas fa-bars"></i></a>
                </li>
                <li class="mr-2 nav-item d-none d-sm-inline-block">
                    <button type="button"
                            v-bind:class="[ parsStateValue.class ?  'btn btn-block bg-gradient-success' : 'btn btn-block bg-gradient-secondary']"
                            v-on:click="parseStateClick()">
                        <b-spinner v-if="this.parsStateValue.spinVisible" small type="grow"></b-spinner>
                        Парсинг<!--:  {{ parsState }} -->
                    </button>
                </li>
                <li class="mr-2 nav-item d-none d-sm-inline-block">
                    <button type="button"
                            v-bind:class="[ bettingStateValue.class ?  'btn btn-block bg-gradient-success' : 'btn btn-block bg-gradient-secondary']"
                            v-on:click="bettingStateClick()">
                        <b-spinner v-if="this.bettingStateValue.spinVisible" small type="grow"></b-spinner>
                        Установка ставок<!--: {{ betState }} -->
                    </button>
                </li>
                <li class="mr-2 nav-item d-none d-sm-inline-block">
                    <span class="float-right dropdown-item">
                    <i class="fas fa-memory mr-2"></i>{{ memory }}
                    </span>
                </li>
            </ul>

            <ul class="navbar-nav ml-auto">
                <!-- Notifications Dropdown Menu -->
                <li class="nav-item dropdown">
                    <a class="nav-link" data-toggle="dropdown" href="#">
                        <i class="fas fa-dollar-sign"></i>
                    </a>
                    <div class="dropdown-menu dropdown-menu-lg dropdown-menu-right">
                        <div class="dropdown-divider"></div>
                        <a href="#" class="dropdown-item">
                            <i class="fas fa-money-bill-alt mr-2"></i> Баланс
                            <span class="float-right text-muted text-sm">{{ balance }}</span>
                        </a>
                        <div class="dropdown-divider"></div>
                        <a href="#" class="dropdown-item">
                            <i class="fas fa-university mr-2"></i> Кредит
                            <span class="float-right text-muted text-sm">{{ credit }}</span>
                        </a>
                        <div class="dropdown-divider"></div>
                        <a href="#" class="dropdown-item">
                            <i class="fas fa-exchange-alt mr-2"></i> Profit/Loss
                            <span class="float-right text-muted text-sm">{{ pl }}</span>
                        </a>
                        <div class="dropdown-divider"></div>
                    </div>
                </li>
            </ul>

        </nav>
        <!-- /.navbar -->

        <aside class="main-sidebar sidebar-dark-primary elevation-4">

            <a href="/" class="brand-link">
                <img src="lte/dist/img/logo.png" alt="BukBot" style="opacity: .8" class="brand-image elevation-3">
                <span class="brand-text font-weight-light">Buk Bot</span>
            </a>

            <div class="sidebar">
                <!-- Sidebar user (optional) -->

                <nav class="mt-2">
                    <ul class="nav nav-pills nav-sidebar flex-column" data-widget="treeview" role="menu"
                        data-accordion="false">
                        <li class="nav-item">
                            <a href="/" class="nav-link">
                                <i class="nav-icon fas fa-home"></i>
                                <p>Главная</p>
                            </a>
                        </li>
                        <li class="nav-item has-treeview">
                            <a href="#" class="nav-link">
                                <i class="nav-icon fas fa-wrench"></i>
                                <p>
                                    Служебное
                                    <i class="right fas fa-angle-left"></i>
                                </p>
                            </a>
                            <ul class="nav nav-treeview">
                                <li class="nav-item">
                                    <a href="/apitest" class="nav-link">
                                        <i class="nav-icon fas fa-cogs"></i>
                                        <p>Настройки</p>
                                    </a>
                                </li>
                                <li class="nav-item">
                                    <a href="/terminal" class="nav-link">
                                        <i class="nav-icon fas fa-terminal"></i>
                                        <p>Консоль бота</p>
                                    </a>
                                </li>
                            </ul>
                        </li>
                    </ul>
                </nav>

            </div>

        </aside>
    </div>
</div><!--th:fragment="menu"-->

<div th:fragment="footer">
    <!-- jQuery -->
    <script th:src="@{lte/plugins/jquery/jquery.min.js}"></script>
    <!-- Bootstrap 4 -->
    <script th:src="@{lte/plugins/bootstrap/js/bootstrap.bundle.min.js}"></script>
    <!-- AdminLTE App -->
    <script th:src="@{lte/dist/js/adminlte.min.js}"></script>
    <!-- AdminLTE for demo purposes -->
    <script th:src="@{lte/dist/js/demo.js}"></script>
    <script th:inline="javascript">
    var base = {
        es: '',
        hash: /*[[${_csrf.token}]]*/,
    }
    var menuApp = new Vue({
        el: '#contents',
        data: {
            id: /*[[${id}]]*/,
            balance: /*[[${balance}]]*/,
            credit: /*[[${credit}]]*/,
            pl: /*[[${pl}]]*/,
            memory: /*[[${memory}]]*/,
            parsStateValue: {
               class: /*[[${stateParse}]]*/,
               spinVisible: false
            },
            bettingStateValue: {
               class: /*[[${stateBetting}]]*/,
               spinVisible: false
            }
        },
        created() {
            this.setupStream();
        },
        methods: {
            setupStream() {

                base.es = new EventSource('../data_listen/' + String(this.id));

                base.es.addEventListener('systemState', event => {
                    let data = JSON.parse(event.data);
                    this.parsStateValue.class = data.stateParser;
                    this.parsStateValue.spinVisible = false;
                    this.bettingStateValue.class = data.stateBetting;
                    this.bettingStateValue.spinVisible = false;
                }, false);

                base.es.addEventListener('balance', event => {
                    let data = JSON.parse(event.data);
                    this.balance = data.balance;
                    this.credit = data.credit;
                    this.pl = data.pl;
                    this.memory = data.memory
                }, false);

                base.es.addEventListener('placeBet', event => {
                    let data = JSON.parse(event.data);
                    if(this.colCount < 10){
                        this.bets.push(data);
                     } else {
                        this.bets.pop();
                        this.bets.unshift(data);
                    }
                }, false);

                base.es.addEventListener('error', event => {
                }, false);
            },
            parseStateClick() {
                this.parsStateValue.spinVisible = true;
                axios.post('/command', 'name=switchParse&_csrf='+base.hash, axiosConfig)
            },
            bettingStateClick() {
                this.bettingStateValue.spinVisible = true;
                axios.post('/command', 'name=switchBetting&_csrf='+base.hash, axiosConfig)
            }
        },

        computed: {
            parsState: function(){
                if(this.parsStateValue.class){
                    return "Active"
                } else {
                    return "Disabled"
                }
            },
            betState: function(){
                if(this.bettingStateValue.class){
                    return "Active"
                } else {
                    return "Disabled"
                }
            }
        }
    });



    </script>
</div>

</body>
</html>